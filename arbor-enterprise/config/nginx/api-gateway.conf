# Nginx API Gateway Caching Configuration
# TIER 11 - Point 59: API Gateway Caching
#
# Provides edge caching for GET requests to reduce backend load.
# HIT ratio target: > 80% for entity details

# Cache zone definition (in http context)
# Add to nginx.conf http block:
# proxy_cache_path /var/cache/nginx/arbor levels=1:2 keys_zone=arbor_cache:100m max_size=10g inactive=60m use_temp_path=off;

upstream arbor_backend {
    zone arbor_upstream 64k;
    
    server arbor-api-1:8000 weight=5;
    server arbor-api-2:8000 weight=5;
    server arbor-api-3:8000 weight=5;
    
    keepalive 100;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=arbor_limit:10m rate=100r/s;
limit_conn_zone $binary_remote_addr zone=arbor_conn:10m;

server {
    listen 80;
    listen [::]:80;
    server_name api.arbor.app;
    
    # Redirect to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.arbor.app;
    
    # SSL configuration
    ssl_certificate /etc/nginx/ssl/arbor.crt;
    ssl_certificate_key /etc/nginx/ssl/arbor.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types application/json text/plain application/javascript;
    
    # Rate limiting
    limit_req zone=arbor_limit burst=200 nodelay;
    limit_conn arbor_conn 50;
    
    # ═══════════════════════════════════════════════════════════════════════
    # Cached Endpoints
    # ═══════════════════════════════════════════════════════════════════════
    
    # Cache entity details for 60 seconds
    # TIER 11 - Point 59: HIT ratio > 80%
    location ~ ^/api/v1/entities/([a-zA-Z0-9_-]+)$ {
        proxy_pass http://arbor_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Cache configuration
        proxy_cache arbor_cache;
        proxy_cache_valid 200 60s;
        proxy_cache_valid 404 10s;
        proxy_cache_key "$request_uri";
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        
        # Cache bypass for authenticated users
        proxy_cache_bypass $cookie_access_token;
        proxy_no_cache $cookie_access_token;
        
        # Add cache status header for debugging
        add_header X-Cache-Status $upstream_cache_status always;
        add_header Cache-Control "public, max-age=60" always;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Cache search results for 30 seconds (shorter TTL for dynamic content)
    location /api/v1/search {
        proxy_pass http://arbor_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Only cache GET requests
        proxy_cache arbor_cache;
        proxy_cache_methods GET;
        proxy_cache_valid 200 30s;
        proxy_cache_key "$request_uri$arg_q$arg_category$arg_city";
        proxy_cache_use_stale error timeout http_500 http_502;
        
        add_header X-Cache-Status $upstream_cache_status always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ═══════════════════════════════════════════════════════════════════════
    # Non-cached Endpoints
    # ═══════════════════════════════════════════════════════════════════════
    
    # Discovery endpoint - no caching (personalized)
    location /api/v1/discover {
        proxy_pass http://arbor_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # SSE streaming support
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        
        proxy_read_timeout 120s;
        proxy_send_timeout 120s;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Write operations - never cache
    location ~ ^/api/v1/(entities|curate|admin) {
        proxy_pass http://arbor_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        proxy_cache off;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
    }
    
    # ═══════════════════════════════════════════════════════════════════════
    # Cache Purge Endpoint (admin only)
    # ═══════════════════════════════════════════════════════════════════════
    
    location /internal/cache/purge {
        # Only allow from internal network
        allow 10.0.0.0/8;
        deny all;
        
        # ngx_cache_purge module required
        proxy_cache_purge arbor_cache "$arg_key";
    }
    
    # Health check - no cache
    location /health {
        proxy_pass http://arbor_backend;
        proxy_cache off;
    }
    
    # Metrics - no cache
    location /metrics {
        proxy_pass http://arbor_backend;
        proxy_cache off;
        
        # Only allow Prometheus scraper
        allow 10.0.0.0/8;
        deny all;
    }
    
    # Default location
    location / {
        proxy_pass http://arbor_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
