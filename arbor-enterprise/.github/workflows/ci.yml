# =============================================================================
# A.R.B.O.R. Enterprise - Continuous Integration
# Lint, type-check, test, and build Docker images on every push/PR
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  POETRY_VERSION: "1.8.3"
  REGISTRY: us-central1-docker.pkg.dev
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REPOSITORY: arbor-enterprise-images

jobs:
  # ---------------------------------------------------------------------------
  # Lint - Code quality checks
  # ---------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: venv-lint-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            venv-lint-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: poetry install --only main,dev --no-root

      - name: Run Ruff linter
        run: poetry run ruff check app/ --output-format=github

      - name: Run Ruff formatter check
        run: poetry run ruff format --check app/

      - name: Run Black formatter check
        run: poetry run black --check app/ tests/

  # ---------------------------------------------------------------------------
  # Type Check - Static type analysis
  # ---------------------------------------------------------------------------
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: venv-typecheck-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            venv-typecheck-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: poetry install --only main,dev --no-root

      - name: Run MyPy
        run: poetry run mypy app/ --ignore-missing-imports --no-error-summary || true

  # ---------------------------------------------------------------------------
  # Test - Unit and integration tests
  # ---------------------------------------------------------------------------
  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_DB: arbor_test
          POSTGRES_USER: arbor
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U arbor -d arbor_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: venv-test-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            venv-test-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: poetry install --no-root

      - name: Run database migrations
        run: poetry run alembic upgrade head
        env:
          DATABASE_URL: postgresql+asyncpg://arbor:test_password@localhost:5432/arbor_test

      - name: Run unit tests
        run: |
          poetry run pytest tests/unit/ \
            -v \
            --tb=short \
            --cov=app \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --junitxml=junit-results.xml
        env:
          APP_ENV: test
          DATABASE_URL: postgresql+asyncpg://arbor:test_password@localhost:5432/arbor_test
          REDIS_URL: redis://localhost:6379/1
          QDRANT_URL: http://localhost:6333
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test_password
          OPENAI_API_KEY: sk-test-key
          TEMPORAL_HOST: localhost:7233

      - name: Run integration tests
        run: |
          poetry run pytest tests/integration/ \
            -v \
            --tb=short \
            --junitxml=junit-integration-results.xml
        env:
          APP_ENV: test
          DATABASE_URL: postgresql+asyncpg://arbor:test_password@localhost:5432/arbor_test
          REDIS_URL: redis://localhost:6379/1
          QDRANT_URL: http://localhost:6333
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test_password
          OPENAI_API_KEY: sk-test-key
          TEMPORAL_HOST: localhost:7233
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: backend/coverage.xml
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: backend/junit-*.xml
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Security Scan - Dependency vulnerability check
  # ---------------------------------------------------------------------------
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install --only main --no-root

      - name: Export requirements
        run: poetry export -f requirements.txt --output requirements.txt --without-hashes

      - name: Run pip-audit
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt --ignore-vuln PYSEC-2024-* || true

  # ---------------------------------------------------------------------------
  # Build Docker Images
  # ---------------------------------------------------------------------------
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test]
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        include:
          - target: api
            dockerfile: infrastructure/docker/Dockerfile.api
            image-name: arbor-api
          - target: worker
            dockerfile: infrastructure/docker/Dockerfile.worker
            image-name: arbor-worker

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ matrix.target }}-${{ github.sha }}
          restore-keys: |
            buildx-${{ matrix.target }}-

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: false
          load: true
          tags: |
            ${{ matrix.image-name }}:${{ github.sha }}
            ${{ matrix.image-name }}:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            APP_VERSION=${{ github.sha }}

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image-name }}:${{ github.sha }}
          format: table
          exit-code: 0
          severity: CRITICAL,HIGH
          timeout: 10m

      - name: Test container health
        run: |
          if [ "${{ matrix.target }}" = "api" ]; then
            docker run -d --name test-container \
              -e APP_ENV=test \
              -e DATABASE_URL=postgresql+asyncpg://test:test@localhost:5432/test \
              -e REDIS_URL=redis://localhost:6379/0 \
              -p 8000:8000 \
              ${{ matrix.image-name }}:${{ github.sha }} || true
            sleep 5
            docker logs test-container 2>&1 | head -50
            docker stop test-container || true
            docker rm test-container || true
          fi

      # Rotate cache
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # ---------------------------------------------------------------------------
  # CI Status Gate
  # ---------------------------------------------------------------------------
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, type-check, test, security, build]
    if: always()
    steps:
      - name: Check CI results
        run: |
          if [ "${{ needs.lint.result }}" = "failure" ] || \
             [ "${{ needs.test.result }}" = "failure" ] || \
             [ "${{ needs.build.result }}" = "failure" ]; then
            echo "CI failed - required checks did not pass"
            exit 1
          fi
          echo "All required CI checks passed"
